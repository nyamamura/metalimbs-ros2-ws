<?xml version="1.0"?>
<robot name="metalimbs" xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- Argument for mesh path -->
  <xacro:arg name="mesh_path" default="package://metalimbs_description/meshes/metalimbs2"/>
  <xacro:property name="mesh_path" value="$(arg mesh_path)"/>
  
  <xacro:property name="PI" value="3.14159265358979"/>
  <xacro:property name="PI_2" value="1.5707963267948966"/>
  <xacro:property name="ToRad" value="${PI/180}"/>
  <xacro:property name="mesh_rpy" value="${PI_2} ${PI} -${PI_2}"/>

  <!-- base link with proper inertia -->
  <link name="base_link">
    <inertial>
      <mass value="0.01"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
    </inertial>
  </link>

  <!-- base mount -->
  <link name="base_mount">
    <inertial>
      <mass value="8.0"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="${mesh_rpy}"/>
      <geometry>
        <mesh filename="${mesh_path}/base_mount.obj" scale="0.001 0.001 0.001"/>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="${mesh_rpy}"/>
      <geometry>
        <mesh filename="${mesh_path}/base_mount.obj" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_mount_joint" type="fixed">
    <parent link="base_link"/>
    <child link="base_mount"/>
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </joint>

  <!-- shoulder1 -->
  <xacro:macro name="shoulder1_link" params="position sign">
    <link name="${position}_shoulder1_link">
      <inertial>
        <mass value="0.2"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
      </inertial>
      <visual>
        <origin xyz="0 0.1925 0" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/shoulder1.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0.1925 0" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/shoulder1.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_shoulder1_joint" type="fixed">
      <parent link="base_mount"/>
      <child link="${position}_shoulder1_link"/>
      <origin xyz="0 ${-sign * 0.1925} 0" rpy="0 0 0"/>
    </joint>
  </xacro:macro>

  <!-- shoulder2 mount -->
  <xacro:macro name="shoulder2_mount" params="position sign">
    <link name="${position}_shoulder2_mount">
      <inertial>
        <mass value="0.5"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.002" ixy="0" ixz="0" iyy="0.002" iyz="0" izz="0.002"/>
      </inertial>
      <visual>
        <origin xyz="0.0775 ${sign * 0.1925} 0" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/shoulder2_mount_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0.0775 ${sign * 0.1925} 0" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/shoulder2_mount_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_shoulder2_mount_joint" type="revolute">
      <parent link="${position}_shoulder1_link"/>
      <child link="${position}_shoulder2_mount"/>
      <origin xyz="-0.0775 0 0" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit lower="${-65 * ToRad}" upper="${125 * ToRad}" effort="10.0" velocity="1.0"/>
      <dynamics damping="0.1" friction="0.05"/>
    </joint>
  </xacro:macro>

  <!-- shoulder2 -->
  <xacro:macro name="shoulder2" params="position sign">
    <link name="${position}_shoulder2_link">
      <inertial>
        <mass value="1.0"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.005" ixy="0" ixz="0" iyy="0.005" iyz="0" izz="0.005"/>
      </inertial>
      <visual>
        <origin xyz="0.0775 ${sign * 0.3085} 0" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/shoulder2_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0.0775 ${sign * 0.3085} 0" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/shoulder2_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_shoulder2_joint" type="revolute">
      <parent link="${position}_shoulder2_mount"/>
      <child link="${position}_shoulder2_link"/>
      <origin xyz="0 ${-sign * 0.116} 0" rpy="0 ${sign * PI_2} 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-115 * ToRad}" upper="${15 * ToRad}" effort="10.0" velocity="1.0"/>
      <dynamics damping="0.1" friction="0.05"/>
    </joint>
  </xacro:macro>

  <!-- upper arm -->
  <xacro:macro name="upper_arm" params="position sign">
    <link name="${position}_upper_arm">
      <inertial>
        <mass value="0.8"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.004" ixy="0" ixz="0" iyy="0.004" iyz="0" izz="0.004"/>
      </inertial>
      <visual>
        <origin xyz="0.0775 ${sign * 0.3} 0.1835" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/upper_arm_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0.0775 ${sign * 0.3} 0.1835" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/upper_arm_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_upper_arm_joint" type="revolute">
      <parent link="${position}_shoulder2_link"/>
      <child link="${position}_upper_arm"/>
      <origin xyz="0 ${sign * 0.0085} -0.1835" rpy="${sign * 90 * ToRad} 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-95 * ToRad}" upper="${95 * ToRad}" effort="10.0" velocity="1.0"/>
      <dynamics damping="0.1" friction="0.05"/>
    </joint>
  </xacro:macro>

  <!-- elbow -->
  <xacro:macro name="elbow" params="position sign">
    <link name="${position}_elbow">
      <inertial>
        <mass value="0.6"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.003" ixy="0" ixz="0" iyy="0.003" iyz="0" izz="0.003"/>
      </inertial>
      <visual>
        <origin xyz="0.0775 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/elbow_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0.0775 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/elbow_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_elbow_joint" type="revolute">
      <parent link="${position}_upper_arm"/>
      <child link="${position}_elbow"/>
      <origin xyz="0 0 -0.3295" rpy="0 0 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-35 * ToRad}" upper="${125 * ToRad}" effort="10.0" velocity="1.0"/>
      <dynamics damping="0.1" friction="0.05"/>
    </joint>
  </xacro:macro>

  <!-- forearm -->
  <xacro:macro name="forearm" params="position sign">
    <link name="${position}_forearm">
      <inertial>
        <mass value="0.4"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.002" ixy="0" ixz="0" iyy="0.002" iyz="0" izz="0.002"/>
      </inertial>
      <visual>
        <origin xyz="-0.1175 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/forearm_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="-0.1175 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/forearm_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_forearm_joint" type="revolute">
      <parent link="${position}_elbow"/>
      <child link="${position}_forearm"/>
      <origin xyz="0.195 0 0" rpy="0 -${PI_2} 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-110 * ToRad}" upper="${110 * ToRad}" effort="10.0" velocity="1.0"/>
      <dynamics damping="0.1" friction="0.05"/>
    </joint>
  </xacro:macro>

  <!-- wrist -->
  <xacro:macro name="wrist" params="position sign">
    <link name="${position}_wrist">
      <inertial>
        <mass value="0.3"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
      </inertial>
      <visual>
        <origin xyz="-0.4165 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/wrist_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="-0.4165 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/wrist_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_wrist_joint" type="revolute">
      <parent link="${position}_forearm"/>
      <child link="${position}_wrist"/>
      <origin xyz="-0.299 0 0" rpy="0 ${PI_2} 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-95 * ToRad}" upper="${95 * ToRad}" effort="10.0" velocity="1.0"/>
      <dynamics damping="0.1" friction="0.05"/>
    </joint>
  </xacro:macro>

  <!-- handunit mount -->
  <xacro:macro name="handunit_mount" params="position sign">
    <link name="${position}_handunit_mount">
      <inertial>
        <mass value="0.2"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
      </inertial>
      <visual>
        <origin xyz="-0.5565 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/handunit_mount_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="-0.5565 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/handunit_mount_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_handunit_mount_joint" type="revolute">
      <parent link="${position}_wrist"/>
      <child link="${position}_handunit_mount"/>
      <origin xyz="-0.14 0 0" rpy="0 -${PI_2} 0"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-35 * ToRad}" upper="${35 * ToRad}" effort="5.0" velocity="1.0"/>
      <dynamics damping="0.1" friction="0.05"/>
    </joint>
  </xacro:macro>

  <!-- handunit -->
  <xacro:macro name="handunit" params="position sign">
    <link name="${position}_handunit">
      <inertial>
        <mass value="0.5"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia ixx="0.002" ixy="0" ixz="0" iyy="0.002" iyz="0" izz="0.002"/>
      </inertial>
      <visual>
        <origin xyz="-0.6815 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/handunit_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="-0.6815 ${sign * 0.3} 0.513" rpy="${mesh_rpy}"/>
        <geometry>
          <mesh filename="${mesh_path}/handunit_${position}.obj" scale="0.001 0.001 0.001"/>
        </geometry>
      </collision>
    </link>

    <joint name="${position}_handunit_joint" type="fixed">
      <parent link="${position}_handunit_mount"/>
      <child link="${position}_handunit"/>
      <origin xyz="-0.125 0 0" rpy="0 0 0"/>
    </joint>
  </xacro:macro>

  <!-- Instantiate links for left arm -->
  <xacro:shoulder1_link position="left" sign="1"/>
  <xacro:shoulder2_mount position="left" sign="1"/>
  <xacro:shoulder2 position="left" sign="1"/>
  <xacro:upper_arm position="left" sign="1"/>
  <xacro:elbow position="left" sign="1"/>
  <xacro:forearm position="left" sign="1"/>
  <xacro:wrist position="left" sign="1"/>
  <xacro:handunit_mount position="left" sign="1"/>
  <xacro:handunit position="left" sign="1"/>

  <!-- Instantiate links for right arm -->
  <xacro:shoulder1_link position="right" sign="-1"/>
  <xacro:shoulder2_mount position="right" sign="-1"/>
  <xacro:shoulder2 position="right" sign="-1"/>
  <xacro:upper_arm position="right" sign="-1"/>
  <xacro:elbow position="right" sign="-1"/>
  <xacro:forearm position="right" sign="-1"/>
  <xacro:wrist position="right" sign="-1"/>
  <xacro:handunit_mount position="right" sign="-1"/>
  <xacro:handunit position="right" sign="-1"/>

  <!-- Gazebo specific elements -->
  
  <!-- Gazebo colors and physics properties -->
  <gazebo reference="base_mount">
    <material>Gazebo/Grey</material>
  </gazebo>

  <xacro:macro name="gazebo_link_properties" params="link_name">
    <gazebo reference="${link_name}">
      <material>Gazebo/DarkGrey</material>
      <mu1>0.2</mu1>
      <mu2>0.2</mu2>
    </gazebo>
  </xacro:macro>

  <!-- Apply properties to all links -->
  <xacro:gazebo_link_properties link_name="left_shoulder1_link"/>
  <xacro:gazebo_link_properties link_name="right_shoulder1_link"/>
  <xacro:gazebo_link_properties link_name="left_shoulder2_mount"/>
  <xacro:gazebo_link_properties link_name="right_shoulder2_mount"/>
  <xacro:gazebo_link_properties link_name="left_shoulder2_link"/>
  <xacro:gazebo_link_properties link_name="right_shoulder2_link"/>
  <xacro:gazebo_link_properties link_name="left_upper_arm"/>
  <xacro:gazebo_link_properties link_name="right_upper_arm"/>
  <xacro:gazebo_link_properties link_name="left_elbow"/>
  <xacro:gazebo_link_properties link_name="right_elbow"/>
  <xacro:gazebo_link_properties link_name="left_forearm"/>
  <xacro:gazebo_link_properties link_name="right_forearm"/>
  <xacro:gazebo_link_properties link_name="left_wrist"/>
  <xacro:gazebo_link_properties link_name="right_wrist"/>
  <xacro:gazebo_link_properties link_name="left_handunit_mount"/>
  <xacro:gazebo_link_properties link_name="right_handunit_mount"/>
  <xacro:gazebo_link_properties link_name="left_handunit"/>
  <xacro:gazebo_link_properties link_name="right_handunit"/>

  <!-- Add the ros2_control Gazebo plugin -->
  <gazebo>
    <plugin filename="ign_ros2_control-system" name="ign_ros2_control">
      <parameters>$(find metalimbs_description)/config/ros2_controllers.yaml</parameters>
    </plugin>
  </gazebo>

  <!-- ros2_control hardware interface -->
  <ros2_control name="IgnitionSystem" type="system">
    <hardware>
      <plugin>ign_ros2_control/IgnitionSystem</plugin>
    </hardware>
    
    <!-- Left arm joints -->
    <joint name="left_shoulder2_mount_joint">
      <command_interface name="position">
        <param name="min">-1.134</param>
        <param name="max">2.182</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="left_shoulder2_joint">
      <command_interface name="position">
        <param name="min">-2.007</param>
        <param name="max">0.262</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="left_upper_arm_joint">
      <command_interface name="position">
        <param name="min">-1.658</param>
        <param name="max">1.658</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="left_elbow_joint">
      <command_interface name="position">
        <param name="min">-0.611</param>
        <param name="max">2.182</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="left_forearm_joint">
      <command_interface name="position">
        <param name="min">-1.92</param>
        <param name="max">1.92</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="left_wrist_joint">
      <command_interface name="position">
        <param name="min">-1.658</param>
        <param name="max">1.658</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="left_handunit_mount_joint">
      <command_interface name="position">
        <param name="min">-0.611</param>
        <param name="max">0.611</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <!-- Right arm joints -->
    <joint name="right_shoulder2_mount_joint">
      <command_interface name="position">
        <param name="min">-1.134</param>
        <param name="max">2.182</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="right_shoulder2_joint">
      <command_interface name="position">
        <param name="min">-2.007</param>
        <param name="max">0.262</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="right_upper_arm_joint">
      <command_interface name="position">
        <param name="min">-1.658</param>
        <param name="max">1.658</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="right_elbow_joint">
      <command_interface name="position">
        <param name="min">-0.611</param>
        <param name="max">2.182</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="right_forearm_joint">
      <command_interface name="position">
        <param name="min">-1.92</param>
        <param name="max">1.92</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="right_wrist_joint">
      <command_interface name="position">
        <param name="min">-1.658</param>
        <param name="max">1.658</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>

    <joint name="right_handunit_mount_joint">
      <command_interface name="position">
        <param name="min">-0.611</param>
        <param name="max">0.611</param>
      </command_interface>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>
  </ros2_control>

</robot>